<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>POP Buffer Demo</title>

    <link rel="stylesheet" href="main.css" />

    <!-- load libraries -->
    <script type="text/javascript" src="script/lib/glMatrix.min.js"></script>
    <script type="text/javascript" src="script/lib/glUtils.js"></script>

    <!-- load app scripts -->
    <script type="text/javascript" src="script/drawer.js"></script>
    <script type="text/javascript" src="script/loader.js"></script>
    <script type="text/javascript" src="script/ui.js"></script>
    <script type="text/javascript" src="script/helper.js"></script>

    <script id="triangle-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;
        attribute vec2 aVertexNormal;

        uniform int uClusterFactor;

        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;
        uniform mat3 uNMatrix;

        uniform vec3 uMinValues;
        uniform vec3 uMaxValues;
        varying vec3 vLightWeighting;
        varying vec3 vVertexColor;
        varying vec3 vNormal;

        vec3 decodeNormal(float u, float v) {
            vec3 nor = vec3(u, v, 0.);
            // Transform normal values from range [0, UCHAR_MAX] to range [-1, 1]
            nor.xy = nor.xy / 127. - 1.;

            // Invert octahedron calulation
            nor.z = 1.0 - abs(nor.x) - abs(nor.y);
            nor.xy = nor.z >= 0.0 ? nor.xy : (1.0 - abs(nor.yx)) * sign(nor.xy);
            return normalize(nor);
        }

        void main() {
            // Transform coordinates back to original coordinates
            vec3 transformedPosition = floor(aVertexPosition / vec3(uClusterFactor)) * vec3(uClusterFactor) / vec3(65535) * (uMaxValues - uMinValues) + uMinValues;
            gl_Position = uPMatrix * uMVMatrix * vec4(transformedPosition, 1.0);

            // Decode and transform normal
            vNormal =  uNMatrix * normalize(decodeNormal(aVertexNormal.x, aVertexNormal.y));
        }
    </script>


    <script id="triangle-fs" type="x-shader/x-fragment">
        precision mediump float;

        varying vec3 vLightWeighting;
        varying vec3 vNormal;

        uniform vec3 uAmbientColor;
        uniform vec3 uLightingDirection;
        uniform vec3 uDirectionalColor;

        void main() {
            // Calculate lighting
            float directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);
            vec3 lightWeighting = uAmbientColor + uDirectionalColor * directionalLightWeighting;
            gl_FragColor = vec4(lightWeighting, 1.0);
        }
    </script>

    <!-- Start App -->
    <script type="text/javascript">
        //When DOM loading is complete:
        function start() {
            // get canvas and make it a global variable
            canvas = document.getElementById('mainCanvas');

            // try to get context and make it a global variable
            gl = WebGLUtils.create3DContext(canvas, {preserveDrawingBuffer:true});
            if (!gl) {
                alert("Dieser Browser unterst√ºtzt leider kein WebGL oder es ist deaktiviert.");
                return false;
            }

            drawer = new Drawer();

            // start loading
            var modelName = window.location.hash ? window.location.hash.substr(1) : 'bunny';
            loader.load(modelName+".json");
        }
    </script>
</head>
<body onload="start()">

<h2>POP Buffer Demo</h2>

<p>This is a sample implementation for the <a href="http://x3dom.org/pop/">POP Buffer</a> introduced by the team of <a href="http://x3dom.org">X3DOM</a> in 2013. It consists of a simple WebGL renderer and a small writing component that creates POP Buffer binaries from obj files.</p>

<canvas id="mainCanvas"></canvas>

<div style="margin-top: 50px;">
    <table>
        <tr><td>Level:</td><td id="levelSliderContainer"></td></tr>
        <tr><td>Current Vertex Count:</td><td id="currentVertexCount"></td></tr>
        <tr><td>Overall Vertex Count:</td><td id="vertexCount"></td></tr>
    </table>

    <progress id="vertexCountProgressBar" max="0" value="0"></progress>
</div>

</body>
</html>
